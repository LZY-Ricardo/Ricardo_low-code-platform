<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalStorage å®¹é‡æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
        }
        button:hover {
            background: #40a9ff;
        }
        button.danger {
            background: #ff4d4f;
        }
        button.danger:hover {
            background: #ff7875;
        }
        .status {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .progress {
            background: #e6f7ff;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .error {
            background: #fff1f0;
            border: 1px solid #ffccc7;
            color: #cf1322;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #389e0d;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¦ LocalStorage å®¹é‡æµ‹è¯•å·¥å…·</h1>
        
        <div class="controls">
            <button onclick="testStorageLimit()">æµ‹è¯•å­˜å‚¨æé™</button>
            <button onclick="testProjectSave()">æµ‹è¯•é¡¹ç›®ä¿å­˜</button>
            <button onclick="checkCurrentUsage()">æŸ¥çœ‹å½“å‰ä½¿ç”¨é‡</button>
            <button class="danger" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
        </div>

        <div id="output"></div>
    </div>

    <script>
        const output = document.getElementById('output');

        function log(message, type = 'status') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = message;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }

        function getCurrentStorageSize() {
            let total = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    total += localStorage[key].length + key.length;
                }
            }
            return total * 2; // UTF-16 ç¼–ç ï¼Œæ¯ä¸ªå­—ç¬¦2å­—èŠ‚
        }

        function checkCurrentUsage() {
            output.innerHTML = '';
            const size = getCurrentStorageSize();
            const itemCount = localStorage.length;
            
            log(`ğŸ“Š å½“å‰ LocalStorage ä½¿ç”¨æƒ…å†µï¼š\n` +
                `- æ¡ç›®æ•°é‡: ${itemCount}\n` +
                `- ä½¿ç”¨ç©ºé—´: ${formatBytes(size)}\n` +
                `- é¢„ä¼°å‰©ä½™: ${formatBytes(10 * 1024 * 1024 - size)} (å‡è®¾é™åˆ¶ä¸º10MB)`, 'progress');
            
            if (itemCount > 0) {
                log('\nå­˜å‚¨çš„é”®å€¼ï¼š', 'status');
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    const size = (key.length + value.length) * 2;
                    log(`  ${key}: ${formatBytes(size)}`, 'status');
                }
            }
        }

        function testStorageLimit() {
            output.innerHTML = '';
            log('ğŸš€ å¼€å§‹æµ‹è¯• LocalStorage å®¹é‡æé™...', 'progress');
            
            const testKey = 'storage_limit_test_';
            let chunkSize = 100 * 1024; // æ¯æ¬¡å†™å…¥100KB
            let totalWritten = 0;
            let chunkIndex = 0;
            
            try {
                while (true) {
                    const data = 'x'.repeat(chunkSize);
                    const key = testKey + chunkIndex;
                    
                    localStorage.setItem(key, data);
                    totalWritten += chunkSize * 2;
                    chunkIndex++;
                    
                    if (chunkIndex % 10 === 0) {
                        log(`å·²å†™å…¥: ${formatBytes(totalWritten)}`, 'progress');
                    }
                }
            } catch (error) {
                if (error.name === 'QuotaExceededError' || error.code === 22) {
                    log(`\nâŒ è§¦å‘å­˜å‚¨é™åˆ¶ï¼`, 'error');
                    log(`é”™è¯¯ç±»å‹: ${error.name}`, 'error');
                    log(`é”™è¯¯ä¿¡æ¯: ${error.message}`, 'error');
                    log(`\næœ€ç»ˆå†™å…¥æ•°æ®é‡: ${formatBytes(totalWritten)}`, 'success');
                    
                    // æ¸…ç†æµ‹è¯•æ•°æ®
                    for (let i = 0; i < chunkIndex; i++) {
                        localStorage.removeItem(testKey + i);
                    }
                    log('\nâœ… å·²æ¸…ç†æµ‹è¯•æ•°æ®', 'success');
                } else {
                    log(`\nâŒ æœªçŸ¥é”™è¯¯: ${error.name} - ${error.message}`, 'error');
                }
            }
        }

        function testProjectSave() {
            output.innerHTML = '';
            log('ğŸ§ª æ¨¡æ‹Ÿé¡¹ç›®ä¿å­˜æµ‹è¯•...', 'progress');
            
            // åˆ›å»ºä¸€ä¸ªå¤§å‹é¡¹ç›®
            const largeProject = {
                id: Date.now() + '_test',
                name: 'æµ‹è¯•è¶…å¤§é¡¹ç›®',
                components: [],
                createdAt: Date.now(),
                updatedAt: Date.now()
            };
            
            // æ·»åŠ å¤§é‡ç»„ä»¶
            for (let i = 0; i < 1000; i++) {
                largeProject.components.push({
                    id: i,
                    name: 'Container',
                    props: {
                        style: { 
                            width: '100%', 
                            height: '200px',
                            background: 'linear-gradient(to right, #ff0000, #00ff00)',
                            padding: '20px',
                            margin: '10px'
                        },
                        text: 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. '.repeat(10)
                    },
                    desc: 'å®¹å™¨ç»„ä»¶',
                    children: Array(5).fill(null).map((_, j) => ({
                        id: i * 1000 + j,
                        name: 'Button',
                        props: { text: `æŒ‰é’® ${i}-${j}` },
                        desc: 'æŒ‰é’®'
                    }))
                });
            }
            
            const projectJson = JSON.stringify(largeProject);
            const projectSize = projectJson.length * 2;
            
            log(`é¡¹ç›®ç»„ä»¶æ•°é‡: ${largeProject.components.length}`, 'status');
            log(`é¡¹ç›®JSONå¤§å°: ${formatBytes(projectSize)}`, 'status');
            
            try {
                const startUsage = getCurrentStorageSize();
                localStorage.setItem('lowcode_test_project', projectJson);
                const endUsage = getCurrentStorageSize();
                
                log(`\nâœ… é¡¹ç›®ä¿å­˜æˆåŠŸï¼`, 'success');
                log(`å­˜å‚¨å‰: ${formatBytes(startUsage)}`, 'success');
                log(`å­˜å‚¨å: ${formatBytes(endUsage)}`, 'success');
                log(`å¢åŠ é‡: ${formatBytes(endUsage - startUsage)}`, 'success');
                
                // æµ‹è¯•èƒ½å¦è¯»å–
                const loaded = JSON.parse(localStorage.getItem('lowcode_test_project'));
                log(`\nâœ… é¡¹ç›®è¯»å–æˆåŠŸï¼ç»„ä»¶æ•°: ${loaded.components.length}`, 'success');
                
                // æ¸…ç†
                localStorage.removeItem('lowcode_test_project');
                log(`âœ… å·²æ¸…ç†æµ‹è¯•é¡¹ç›®`, 'success');
                
            } catch (error) {
                if (error.name === 'QuotaExceededError' || error.code === 22) {
                    log(`\nâŒ å­˜å‚¨ç©ºé—´ä¸è¶³ï¼`, 'error');
                    log(`é¡¹ç›®å¤§å°: ${formatBytes(projectSize)}`, 'error');
                    log(`å½“å‰ä½¿ç”¨: ${formatBytes(getCurrentStorageSize())}`, 'error');
                    log(`\nğŸ’¡ å»ºè®®ï¼š`, 'progress');
                    log(`1. åˆ é™¤ä¸€äº›æ—§é¡¹ç›®é‡Šæ”¾ç©ºé—´`, 'progress');
                    log(`2. ä½¿ç”¨å¯¼å‡ºåŠŸèƒ½å¤‡ä»½é¡¹ç›®`, 'progress');
                    log(`3. è€ƒè™‘å‡çº§åˆ°åç«¯å­˜å‚¨æ–¹æ¡ˆ`, 'progress');
                } else {
                    log(`\nâŒ é”™è¯¯: ${error.message}`, 'error');
                }
            }
        }

        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ LocalStorage æ•°æ®å—ï¼Ÿ')) {
                const beforeSize = getCurrentStorageSize();
                localStorage.clear();
                output.innerHTML = '';
                log(`âœ… å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®`, 'success');
                log(`é‡Šæ”¾ç©ºé—´: ${formatBytes(beforeSize)}`, 'success');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºå½“å‰ä½¿ç”¨æƒ…å†µ
        checkCurrentUsage();
    </script>
</body>
</html>
